generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ComercioCommodities {
  commodity_id Int                                @id @default(autoincrement())
  nome         String
  variacoes    ComercioCommoditiesVariacaoPreco[]
}

model ComercioCommoditiesVariacaoPreco {
  variacao_id  Int                 @id @default(autoincrement())
  commodity_id Int
  fonte        String?
  valor        Float
  data         DateTime
  commodity    ComercioCommodities @relation(fields: [commodity_id], references: [commodity_id], onDelete: Cascade)
}

model Account {
  id                 String    @id @default(cuid())
  userId             String
  providerType       String
  providerId         String
  providerAccountId  String
  refreshToken       String?
  accessToken        String?
  accessTokenExpires DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user               Usuario   @relation(fields: [userId], references: [id])

  @@unique([providerId, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  accessToken  String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         Usuario  @relation(fields: [userId], references: [id])
}

model Noticia {
  notId                        Int                            @id @default(autoincrement())
  titulo                       String                         @map("titulo") @db.VarChar(200)
  subtitulo                    String                         @map("subtitulo") @db.VarChar(1000)
  corpo                        String                         @map("corpo")
  dataPubli                    DateTime                       @map("data_publicacao")
  descricao                    String?                        @map("descricao") @db.Text()
  idCultura                    Int                            @map("id_cultura")
  imagemLink                   String                         @map("imagem_link") @db.VarChar(300)
  ComercioInternacionalNoticia ComercioInternacionalNoticia[]
  cultura                      Cultura                        @relation(fields: [idCultura], references: [culturaId])
}

model Cultura {
  culturaId  Int       @id @default(autoincrement()) @map("id_cultura")
  nome       String    @map("nome") @db.VarChar(100)
  descricao  String?   @map("descricao") @db.VarChar(500)
  imagemLink String?   @map("imagem_link") @db.VarChar(300)
  Estoque    Estoque[]
  noticias   Noticia[]
}

model VerificationRequest {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

model TipoPessoa {
  id   Int    @id @default(autoincrement())
  nome String
}

model CategoriaPessoa {
  id        Int      @id @default(autoincrement()) @map("categ_pessoa_id")
  codigo    Int      @map("codigo")
  descricao String   @map("descricao") @db.VarChar(50)
  pessoas   Pessoa[]
}

model ComercioInternacionalNoticia {
  id            Int                   @id @map("cint_id")
  comercioIntId Int                   @unique @map("com_int_com_int_id")
  noticiaId     Int                   @map("not_not_id")
  comercioInt   ComercioInternacional @relation(fields: [comercioIntId], references: [id])
  noticia       Noticia               @relation(fields: [noticiaId], references: [notId])
}

model ComercioInternacionalProduto {
  id            Int                   @id @map("cipi_id")
  produtoInacId Int                   @map("prd_inac_prd_inac_id")
  comercioIntId Int                   @map("com_int_com_int_id")
  comercioInt   ComercioInternacional @relation(fields: [comercioIntId], references: [id])
  produtoInac   ProdutoInac           @relation(fields: [produtoInacId], references: [id])

  @@unique([comercioIntId, produtoInacId])
}

model ComercioInternacional {
  id               Int                            @id @map("com_int_id")
  nome             String?                        @db.VarChar(50)
  valor            Float?
  dataValor        DateTime?                      @map("dt_valor")
  categoria        String?                        @db.VarChar(1)
  descricao        String?                        @map("descrição") @db.VarChar(300)
  noticias         ComercioInternacionalNoticia?
  produtos         ComercioInternacionalProduto[]
  historicoValores HistoricoValores[]
}

model Empresa {
  id               Int                @id @default(autoincrement()) @map("empresa_id")
  nome             String             @db.VarChar(100)
  serial           BigInt
  usuarios         Usuario[]
  estoques         Estoque[]
  HistoricoEstoque HistoricoEstoque[]
  transacoes       Transacao[]
  Venda            Venda[]
}

model Endereco {
  id          Int     @id @default(autoincrement()) @map("endereco_id")
  logradouro  String  @db.VarChar(100)
  numero      Int
  bairro      String  @db.VarChar(100)
  complemento String  @db.VarChar(100)
  cidade      String  @db.VarChar(100)
  estado      String? @db.VarChar(2)
  cep         Int?
  pais        String  @db.VarChar(100)
  pessoaId    Int     @map("pessoa_pess_pessoa_id")
  pessoa      Pessoa  @relation(fields: [pessoaId], references: [id])
}

model Estoque {
  id                 Int      @id @default(autoincrement()) @map("estoque_id")
  produto            String   @db.VarChar(50)
  categoriaculturaId Int?
  tipo               String   @db.VarChar(1)
  descricao          String   @db.VarChar(2000)
  quantidade         Float    @map("qtd")
  preco              Float
  unidadeMedida      String   @map("unidade_medida") @db.VarChar(25)
  imagemLink         String?  @map("imagem_link") @db.VarChar(300)
  ativo              Boolean  @default(true)
  foiUtilizado       Boolean  @default(false) @map("foi_utilizado")
  empresaId          Int      @map("empresa_id")
  dataAdicao         DateTime @default(now()) @map("dataAdicao")

  // Seeds-specific fields
  genero              String? // gênero
  especie             String? // espécie
  variedade           String? // variedade
  corDaFolhagem       String? // cor da folhagem
  requisitosDeLuz     String? // requisitos de luz
  requisitosDeUmidade String? // requisitos de umidade
  tipoDeSolo          String? // tipo de solo
  zonaDeResistencia   String? // zona de resistência
  diasParaMaturidade  String? // dias para maturidade
  alturaMadura        String? // altura madura
  diasParaGerminacao  String? // dias para germinação
  infoSolSombra       String? // informações sobre sol/sombra

  // Relations
  categoriaId    Cultura?           @relation(fields: [categoriaculturaId], references: [culturaId])
  empresa        Empresa?           @relation(fields: [empresaId], references: [id])
  historicos     HistoricoEstoque[]
  vendas         VendaEstoque[]
  reviews        EstoqueReview[]
  transacaoItens TransacaoItem[]
}

model EstoqueReview {
  id           Int      @id @default(autoincrement())
  estoqueId    Int      @map("estoque_id")
  rating       Int // 1-5 stars
  comment      String   @db.Text
  reviewerName String   @map("reviewer_name") @db.VarChar(100)
  createdAt    DateTime @default(now()) @map("created_at")

  estoque Estoque @relation(fields: [estoqueId], references: [id], onDelete: Cascade)

  @@index([estoqueId])
}

model FormaPagamento {
  id     Int                   @id @map("form_pag_id")
  codigo Int
  tipo   String                @db.VarChar(30)
  vendas VendaFormaPagamento[]
}

model HistoricoEstoque {
  id         Int      @id @default(autoincrement()) @map("hist_estq_id")
  dataAlter  DateTime @map("dt_alter")
  horaAlter  String   @map("hora_alter") @db.VarChar(5)
  valorAlter Float    @map("valor_alter")
  comprador  Boolean  @default(false)
  estoqueId  Int      @map("estoque_estoque_id")
  vendaId    Int      @map("venda_venda_id")
  empresaId  Int      @map("empresa_id")
  estoque    Estoque  @relation(fields: [estoqueId], references: [id])
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  venda      Venda    @relation(fields: [vendaId], references: [id])
  Usuario    Usuario? @relation(fields: [usuarioId], references: [id])
  usuarioId  String?
}

model HistoricoValores {
  id            Int                   @id @map("hist_valores_id")
  valor         Float
  dataValorHist DateTime              @map("dt_valor_hist")
  comercioIntId Int                   @map("com_int_com_int_id")
  comercioInt   ComercioInternacional @relation(fields: [comercioIntId], references: [id])
}

model Imagem {
  id     Int    @id @map("imagem_id")
  imagem String @db.VarChar(200)
}

model Mensagem {
  id        Int    @id @map("mensagem_id")
  descricao String @db.VarChar(100)
}

model Moeda {
  sigla          String @id @map("sigla") @db.VarChar(10)
  nome           String @map("nome") @db.VarChar(40)
  codigoBandeira String @map("codigo_bandeira") @db.VarChar(40)
}

model Pessoa {
  id             Int             @id @default(autoincrement()) @map("pess_pessoa_id")
  email          String          @map("pess_email") @db.VarChar(50)
  imagemLink     String?         @map("imagem_link") @db.VarChar(300)
  categoriaId    Int             @map("categ_pess_categ_pessoa_id")
  enderecos      Endereco[]
  categoria      CategoriaPessoa @relation(fields: [categoriaId], references: [id])
  pessoaFisica   PessoaFisica?
  pessoaJuridica PessoaJuridica?
  telefones      Telefone[]
  VendaPessoa    VendaPessoa[]
}

model PessoaFisica {
  id             Int      @id @default(autoincrement()) @map("pess_pessoa_id")
  nome           String   @map("pepf_nome") @db.VarChar(100)
  cpf            BigInt   @map("pepf_cpf")
  dataNascimento DateTime @map("pepf_dt_nascimento")
  rg             BigInt?  @map("pepf_rg")
  pessoa         Pessoa   @relation(fields: [id], references: [id])
}

model PessoaJuridica {
  id                Int     @id @default(autoincrement()) @map("pess_pessoa_id")
  razaoSocial       String  @map("psjr_razao_social") @db.VarChar(100)
  cnpj              BigInt  @map("psjr_cnpj")
  inscricaoEstadual BigInt  @map("psjr_insc_esta")
  nomeFantasia      String? @map("psjr_nome_fant") @db.VarChar(100)
  pessoa            Pessoa  @relation(fields: [id], references: [id])
}

model ProdutoInac {
  id              Int                            @id @map("prd_inac_id")
  pais            String                         @db.VarChar(30)
  peso            Float
  valor           Float
  totalExpValPais Float?                         @map("total_exp_val_pais")
  comerciosInt    ComercioInternacionalProduto[]
}

model Telefone {
  id       Int    @id @default(autoincrement()) @map("telefone_id")
  tipo     String @db.VarChar(30)
  numero   String @db.VarChar(30)
  pessoaId Int    @map("pessoa_pess_pessoa_id")
  pessoa   Pessoa @relation(fields: [pessoaId], references: [id])
}

model Usuario {
  id           String             @id @default(cuid())
  nome         String             @db.VarChar(100)
  cpf          String             @db.VarChar(14)
  senha        String             @db.VarChar(14)
  admin        Boolean            @default(false)
  alterarSenha Boolean            @default(false)
  imagemLink   String?            @map("imagem_link") @db.VarChar(300)
  inativado    Boolean            @default(false)
  email        String?            @db.VarChar(300)
  esp1         String?            @db.VarChar(20)
  esp2         String?            @db.VarChar(20)
  empresaId    Int?               @map("empresa_empresa_id")
  Account      Account[]
  historicos   HistoricoEstoque[]
  Session      Session[]
  empresa      Empresa?           @relation(fields: [empresaId], references: [id])
  transacoes   Transacao[]
  Venda        Venda[]
}

model Venda {
  id        Int     @id @default(autoincrement())
  empresaId Int     @map("empresa_id")
  usuarioId String  @map("usuario_id")
  comprador Boolean @default(false)

  // NOVOS CAMPOS
  status        String    @default("PENDENTE") @db.VarChar(50)
  valorTotal    Float?    @map("valor_total")
  dataPagamento DateTime? @map("data_pagamento")
  observacoes   String?   @db.Text
  dataVenda     DateTime  @default(now()) @map("data_venda")

  // Relações
  empresa             Empresa               @relation(fields: [empresaId], references: [id])
  usuario             Usuario               @relation(fields: [usuarioId], references: [id])
  transacoes          Transacao[]
  estoques            VendaEstoque[]
  historicos          HistoricoEstoque[]
  VendaFormaPagamento VendaFormaPagamento[]
  VendaPessoa         VendaPessoa[]

  @@map("vendas")
}

model VendaEstoque {
  id            Int   @id @default(autoincrement())
  vendaId       Int   @map("venda_id")
  estoqueId     Int   @map("estoque_id")
  quantidade    Float
  precoUnitario Float @map("preco_unitario")

  venda   Venda   @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  estoque Estoque @relation(fields: [estoqueId], references: [id])

  @@index([vendaId])
  @@index([estoqueId])
  @@map("venda_estoque")
}

model VendaFormaPagamento {
  id               Int            @id @default(autoincrement()) @map("vfpag_id")
  vendaId          Int            @map("venda_venda_id")
  formaPagamentoId Int            @map("forma_pagamento_form_pag_id")
  formaPagamento   FormaPagamento @relation(fields: [formaPagamentoId], references: [id])
  venda            Venda          @relation(fields: [vendaId], references: [id])

  @@unique([formaPagamentoId, vendaId])
}

model Transacao {
  id Int @id @default(autoincrement()) @map("transacao_id")

  // MercadoPago Payment Details
  mercadoPagoPaymentId String  @unique @map("mp_payment_id") // ID do pagamento no MP
  mercadoPagoOrderId   String? @map("mp_order_id") // ID do pedido no MP
  externalReference    String? @map("external_reference") // Sua referência externa

  // Payment Information
  status        String  @db.VarChar(50) // approved, pending, rejected, cancelled, refunded
  statusDetail  String? @map("status_detail") @db.VarChar(100)
  paymentType   String  @map("payment_type") @db.VarChar(50) // credit_card, debit_card, pix, etc
  paymentMethod String? @map("payment_method") @db.VarChar(50) // visa, master, pix, etc

  // Financial Details
  valorTotal         Float  @map("valor_total")
  valorLiquido       Float? @map("valor_liquido") // Valor após taxas
  taxaMercadoPago    Float? @map("taxa_mp") // Taxa cobrada pelo MP
  parcelasQuantidade Int?   @default(1) @map("parcelas_qtd")

  // Timestamps
  dataCriacao     DateTime  @default(now()) @map("data_criacao")
  dataAprovacao   DateTime? @map("data_aprovacao")
  dataAtualizacao DateTime  @updatedAt @map("data_atualizacao")

  // Customer Information
  pagadorEmail     String? @map("pagador_email") @db.VarChar(255)
  pagadorNome      String? @map("pagador_nome") @db.VarChar(255)
  pagadorDocumento String? @map("pagador_documento") @db.VarChar(20)
  pagadorTelefone  String? @map("pagador_telefone") @db.VarChar(20)

  // Relations
  vendaId   Int?   @map("venda_id")
  empresaId Int    @map("empresa_id")
  usuarioId String @map("usuario_id")

  venda   Venda?  @relation(fields: [vendaId], references: [id])
  empresa Empresa @relation(fields: [empresaId], references: [id])
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  // Additional Details
  itens       TransacaoItem[]
  webhookLogs WebhookLog[]

  // Metadata
  metadata Json? // Para armazenar dados extras do MP

  @@index([mercadoPagoPaymentId])
  @@index([vendaId])
  @@index([status])
  @@index([dataCriacao])
  @@map("transacoes")
}

model VendaPessoa {
  id         Int    @id @default(autoincrement()) @map("vpes_id")
  vendaId    Int    @map("venda_venda_id")
  pessoaId   Int    @map("pessoa_pess_pessoa_id")
  tipoPessoa String @map("tipo_pessoa") @db.VarChar(15)
  pessoa     Pessoa @relation(fields: [pessoaId], references: [id])
  venda      Venda  @relation(fields: [vendaId], references: [id])

  @@unique([vendaId, pessoaId])
}

model TransacaoItem {
  id Int @id @default(autoincrement()) @map("item_id")

  transacaoId Int @map("transacao_id")
  estoqueId   Int @map("estoque_id")

  produtoNome   String @map("produto_nome") @db.VarChar(255)
  quantidade    Float  @map("quantidade")
  precoUnitario Float  @map("preco_unitario")
  precoTotal    Float  @map("preco_total")

  transacao Transacao @relation(fields: [transacaoId], references: [id], onDelete: Cascade)
  estoque   Estoque   @relation(fields: [estoqueId], references: [id])

  @@index([transacaoId])
  @@index([estoqueId])
  @@map("transacao_itens")
}

model WebhookLog {
  id Int @id @default(autoincrement()) @map("log_id")

  transacaoId Int? @map("transacao_id")

  // Webhook Details
  tipo      String  @db.VarChar(50) // payment, merchant_order, etc
  action    String? @db.VarChar(50) // payment.created, payment.updated, etc
  paymentId String? @map("payment_id") @db.VarChar(100)

  // Request Details
  requestBody    Json @map("request_body")
  responseStatus Int  @map("response_status")

  // Timestamps
  recebidoEm   DateTime  @default(now()) @map("recebido_em")
  processadoEm DateTime? @map("processado_em")

  // Error Handling
  erro       String? @db.Text
  tentativas Int     @default(1)

  transacao Transacao? @relation(fields: [transacaoId], references: [id])

  @@index([paymentId])
  @@index([recebidoEm])
  @@map("webhook_logs")
}
